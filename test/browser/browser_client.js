!function(){function e(){var e=this;s||(e.constants=require("./constants"),e.utils=require("./services/utils/shared")),e.constants={ERROR_TYPE:{NOT_FOUND:404,SYSTEM:500,ACCESS_DENIED:403,INVALID_CREDENTIALS:401},CONSISTENCY:{QUEUED:0,DEFERRED:1,TRANSACTIONAL:2,ACKNOWLEDGED:3},CLIENT_STATE:{UNINITIALIZED:0,ACTIVE:1,DISCONNECTED:2,ERROR:3,RECONNECTING:4,CONNECTING:5,CONNECTED:6,DISCONNECTING:7,CONNECT_ERROR:8},CONNECTION_POOL_TYPE:{ORDERED:0,RANDOM:1},SYSTEM_HEALTH:{EXCELLENT:0,FAIR:1,TAKING_STRAIN:2,POOR:3},ERROR_SEVERITY:{LOW:0,MEDIUM:1,HIGH:2,FATAL:3}},e.utils={prepareWildPath:function(e){if(!e)return"";for(var t="",n=null,o=0;o<e.length;o++)("*"!=e[o]||"*"!=n)&&(t+=e[o],n=e[o]);return t},makeRe:function(e){return new RegExp("^"+this.escapeRegex(e).replace(/\\\*/g,".*")+"$","i")},escapeRegex:function(e){if("string"!=typeof e)throw new TypeError("Expected a string");return e.replace(/[|\\{}()[\]^$+*?.]/g,"\\//{{utils}}")},wildcardMatch:function(e,t){if(-1==e.indexOf("*"))return e==t;var n=this.prepareWildPath(e);return"*"==n?!0:n==t?!0:this.makeRe(n).test(t)},whilst:function(e,t,n){if(n=n||noop,!e())return n(null);var o=this;o.__attempts=0;var r=function(i,s){return o.__attempts++,i?n(i,o.__attempts):e.apply(this,s)?t(o.__attempts,r):void n.apply(null,[null].concat(s,o.__attempts))}.bind(o);t(o.__attempts,r)},async:function(e,t,n,o){var r,i,s,a=0,c=0,u=e.length-1,l=!1;if("number"==typeof t?(r=t,s=n,i=o||function(){}):(s=t,i=n||function(){},r=e.length),!e.length)return i();var p=s.length,f=function(){return!l&&r>a&&u>c},d=function(e){l||(a--,e||c===u&&!a?(l=!0,i(e)):f()&&h(++c))},h=function _(){a++;var t=2===p?[e[c],d]:[e[c],c,d];s.apply(null,t),f()&&_(++c)};h()},clone:function(e){return JSON.parse(JSON.stringify(e))},checkPath:function(e){if(null==e.match(/^[a-zA-Z0-9@.\/\/_*\/-\s]+$/))throw"Bad path, can only contain alphanumeric characters, forward slashes, underscores @ and minus signs, and the * wildcard character ie: /this/is/an/example/of/1/with/an/_*-12hello"},removeLeading:function(e,t){if(null===t||void 0===t)return t;if(null==e)return t;if(""==e)return t;var n=t.toString();return 0==n.indexOf(e)&&(n=n.substring(1,n.length)),n},removeLast:function(e,t){if(null===t||void 0===t)return t;if(null==e)return t;if(""==e)return t;var n=t.toString();return n[n.length-1]==e&&(n=n.substring(0,n.length-1)),n}},i=e.constants.CLIENT_STATE}var t,n,o,r,i,s=!1,a="happn_2";"undefined"!=typeof window&&"undefined"!=typeof document&&(s=!0),"undefined"!=typeof module&&(module.exports=e),s?(window.HappnClient=e,r=window.Primus,t&&"function"==typeof t.promisify||(t=t||{},t.promisify=function(e){return e})):(t=require("bluebird"),n=require("happn-logger"),a="happn_"+require("../package.json").protocol,r=require("happn-primus"));var c=function(e,n){return function(){var o=Array.prototype.slice.call(arguments),r=this;return n&&n.unshift&&o.unshift(n.unshift),"function"==typeof o[o.length-1]?e.apply(this,o):new t(function(t,n){o.push(function(e,o,r){if(e)return n(e);if(r){var i=Array.prototype.slice.call(arguments);return i.shift(),t(i)}return t(o)});try{return e.apply(r,o)}catch(i){return n(i)}})}},u=function(e){if(null==e)return!1;var t=e.config?e.config:e,n=!1,o=!1;if(t.host&&null!=t.host.range){if(!Array.isArray(t.host.range)||2!=t.host.range.length)throw new Error("invalid range option, range must be an array or length must be 2");n=!0}if(t.port&&null!=t.port.range){if(!Array.isArray(t.port.range)||2!=t.port.range.length)throw new Error("invalid range option, range must be an array or length must be 2");o=!0}if(n&&o)throw new Error("invalid range option, range can only be by host or port, not both");return n||o?!0:!1},l=function(e){var t=[],n=e.config?e.config:e,o=JSON.stringify(n);n.port||(n.port=55e3),n.host||(n.host="127.0.0.1");var r=function(e,n){var r=JSON.parse(o);r.host=e,r.port=n,t.push(r)};if(null!=n.host.range)for(var i=n.host.range[0].split("."),s=n.host.range[1].split("."),a=i[3],c=s[3],u=a;c>=u;u++)256>u&&r(i.slice(0,3).join(".")+"."+u,n.port);if(null!=n.port.range)for(var u=n.port.range[0];u<=n.port.range[1];u++)r(n.host,u);return t};e.__instance=function(t){return(new e).client(t)};var p=function(e,t){null==t&&(t={}),Array.isArray(e)&&(t.pool=e),u(e)&&(t.pool=l(e));try{null!=e&&"{}"==JSON.stringify(t)&&(t=e)}catch(n){}return t};e.__prepareOptions=p,e.create=c(function(t,n,o){"function"==typeof t&&(o=t,n={},t=null),"function"==typeof n&&(o=n,n=t?t:{},t=null);var r;try{r=p(t,n)}catch(i){return o(i)}var s=(new e).client(r);return r.testMode&&(e.lastClient=s),s.initialize(function(e,t){return e?"eventemitter"===s.clientType?(s.socket.disconnect(),o(e)):void s.disconnect(function(){o(e)}):o(null,t)})}),e.prototype.client=function(e){var t=this;return e=e||{},e.Logger&&e.Logger.createLogger?this.log=e.Logger.createLogger("HappnClient"):n?(n.configured||n.configure(e.utils),this.log=n.createLogger("HappnClient")):this.log={$$TRACE:function(e,t){return t?console.info("HappnClient",e,t):void console.info("HappnClient",e)},$$DEBUG:function(e,t){return t?console.info("HappnClient",e,t):void console.info("HappnClient",e)},trace:function(e,t){return t?console.info("HappnClient",e,t):void console.info("HappnClient",e)},debug:function(e,t){return t?console.info("HappnClient",e,t):void console.info("HappnClient",e)},info:function(e,t){return t?console.info("HappnClient",e,t):void console.info("HappnClient",e)},warn:function(e,t){return t?console.warn("HappnClient",e,t):void console.info("HappnClient",e)},error:function(e,t){return t?console.error("HappnClient",e,t):void console.info("HappnClient",e)},fatal:function(e,t){return t?console.error("HappnClient",e,t):void console.info("HappnClient",e)}},this.log.$$TRACE("new client()"),this.__initializeProperties(),this.__initializeConnectivity(),this.__prepareOptions(e),this.__initializeEvents(),t},e.prototype.initialize=c(function(e){var t=this;return t.session=null,s?t.getResources(function(n){return n?e(n):void t.authenticate(function(n){return n?e(n):(t.state=i.ACTIVE,void e(null,t))})}):void t.authenticate(function(n){return n?e(n):(t.state=i.ACTIVE,void e(null,t))})}),e.prototype.__prepareSecurityOptions=function(e){e.keyPair&&e.keyPair.publicKey&&(e.publicKey=e.keyPair.publicKey),e.keyPair&&e.keyPair.privateKey&&(e.privateKey=e.keyPair.privateKey)},e.prototype.__prepareSocketOptions=function(e){e.socket||(e.socket={}),e.socket.reconnect||(e.socket.reconnect={}),e.reconnect&&(e.socket.reconnect=e.reconnect),e.socket.reconnect.retries||(e.socket.reconnect.retries=1/0),e.socket.reconnect.max||(e.socket.reconnect.max=18e4),e.socket.timeout=e.connectTimeout?e.connectTimeout:3e4,e.socket.timeout||(e.socket.timeout=1e4),e.socket.reconnect.strategy&&(e.socket.strategy=e.socket.reconnect.strategy),e.socket.strategy||(e.socket.strategy="disconnect,online,timeout")},e.prototype.__prepareConnectionOptions=function(e,t){var n=function(n){e[n]||null==t[n]||(e[n]=t[n])};return t&&(n("host"),n("port"),n("url"),n("protocol"),n("allowSelfSignedCerts"),n("username"),n("password"),n("publicKey"),n("privateKey"),n("token")),e.host||(e.host="127.0.0.1"),e.port||(e.port=55e3),e.url||(e.protocol=e.protocol||"http","http"==e.protocol&&80==parseInt(e.port)?e.url=e.protocol+"://"+e.host:"https"==e.protocol&&443==parseInt(e.port)?e.url=e.protocol+"://"+e.host:e.url=e.protocol+"://"+e.host+":"+e.port),e},e.prototype.__prepareOptions=function(e){var t;if(e.config){t=e.config;for(var n in e)"config"==n||t[n]||(t[n]=e[n])}else t=e;if(t.callTimeout||(t.callTimeout=6e4),t.context&&Object.defineProperty(this,"context",{value:t.context}),t.plugin)for(var o in t.plugin)t.plugin.hasOwnProperty(o)&&(t.plugin[o].bind?this[o]=t.plugin[o].bind(this):this[o]=t.plugin[o]);if(t.pool){var r=this;t.poolReconnectDelay||(t.poolReconnectDelay=0),null==t.poolType&&(t.poolType=r.constants.CONNECTION_POOL_TYPE.RANDOM),null==t.poolReconnectAttempts&&(t.poolReconnectAttempts=4),t.pool=t.pool.map(function(e){return r.__prepareConnectionOptions(e.config?e.config:e,t)})}else t=this.__prepareConnectionOptions(t);this.__prepareSecurityOptions(t),t.allowSelfSignedCerts&&(process.env.NODE_TLS_REJECT_UNAUTHORIZED="0"),this.__prepareSocketOptions(t);var i=null!=t.info?t.info:{};"object"!=typeof i&&(i={data:i}),t.info=i,t.info._browser=s,null==t.loginRetry&&(t.loginRetry=4),null==t.loginRetryInterval&&(t.loginRetryInterval=5e3),null==t.loginTimeout&&(t.loginTimeout=t.callTimeout),this.options=t},e.prototype.__updateOptions=function(e){var t=this,n=function(n){null!=e[n]&&(t.options[n]=e[n])};n("url"),n("host"),n("port"),n("protocol"),n("allowSelfSignedCerts"),n("username"),n("password"),n("publicKey"),n("privateKey"),n("token")},e.prototype.__initializeConnectivity=function(){var e=this;e.initializeConnectionPool=function(t){e.__tried=[],e.__possible=e.options.pool.map(function(e){return e}),t&&(e.__poolAttempts=0)},e.__getConnection=function(t){e.__connectionCleanup(),e.options.socket.manual=!0;try{if(e.options.pool){var n=!1;if(e.__tried?e.__poolAttempts++:e.initializeConnectionPool(!0),e.options.poolReconnectAttempts>0&&e.__poolAttempts>e.options.poolReconnectAttempts)return t(new Error("pool reconnection attempts exceeded"));0==e.__possible.length&&(e.initializeConnectionPool(),n=!0);var o;if(e.options.poolType==e.constants.CONNECTION_POOL_TYPE.RANDOM&&(o=Math.floor(Math.random()*e.__possible.length)),e.options.poolType==e.constants.CONNECTION_POOL_TYPE.ORDERED&&(o=0),e.__updateOptions(e.__possible[o]),e.__tried.push(e.__possible[o]),e.__possible.splice(o,1),n)return setTimeout(function(){e.__connectSocket(t)},e.options.poolReconnectDelay);e.__connectSocket(t)}else e.__connectSocket(t)}catch(r){t(r)}}},e.prototype.__connectSocket=function(e){var t,n=this;if(n.state=i.CONNECTING,s)t=new r(n.options.url,n.options.socket);else{var o=r.createSocket({transformer:n.options.transformer,parser:n.options.parser,manual:!0});t=new o(n.options.url,n.options.socket)}t.on("timeout",function(){return n.state===i.CONNECTING?n.options.pool?n.__getConnection(e):(n.state=i.CONNECT_ERROR,e(new Error("connection timed out"))):void n.handle_error(new Error("connection timed out"))}),t.on("open",function a(){n.state===i.CONNECTING&&(n.state=i.ACTIVE,n.serverDisconnected=!1,t.removeListener("open",a),n.options.pool&&n.initializeConnectionPool(!0),e(null,t))}),t.on("error",function(t){if(n.state===i.CONNECTING){if(n.options.pool)return n.__getConnection(e);n.state=i.CONNECT_ERROR,e(t)}n.handle_error(t)}),t.open()},e.prototype.__initializeProperties=function(){var e=this;e.events={},e.messageEvents={},e.requestEvents={},e.currentEventId=0,e.currentListenerId=0,e.errors=[],e.clientType="socket",e.__systemMessageHandlers=[],e.state=i.UNINITIALIZED,e.__ackHandlers={},e.eventHandlers={}},e.prototype.__initializeEvents=function(){var e=this;e.onEvent=function(t,n){if(!t)throw new Error("event name cannot be blank or null");if("function"!=typeof n)throw new Error("event handler must be a function");return e.eventHandlers[t]||(e.eventHandlers[t]=[]),e.eventHandlers[t].push(n),t+"|"+(e.eventHandlers[t].length-1)},e.offEvent=function(t){var n=t.split("|")[0],o=parseInt(t.split("|")[1]);e.eventHandlers[n][o]=null},e.emit=function(t,n){e.eventHandlers[t]&&e.eventHandlers[t].map(function(e){e&&e.call(e,n)})}},e.prototype.getScript=function(e,t){if(!s)return t(new Error("only for browser"));var n=document.createElement("script");n.src=e;var o=document.getElementsByTagName("head")[0],r=!1;n.onload=n.onreadystatechange=function(){r||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(r=!0,n.onload=n.onreadystatechange=null,o.removeChild(n),t())},o.appendChild(n)},e.prototype.getResources=function(e){var t=this;"undefined"==typeof r?t.getScript(t.options.url+"/browser_primus.js",function(t){if(t)return e(t);if("undefined"==typeof r){if(window&&window.Primus)r=window.Primus;else{if(!document||!document.Primus)return e(new Error("unable to fetch Primus library"));r=document.Primus}e()}}):e()},e.prototype.stop=c(function(e){this.socket.on("end",e),this.socket.end()}),e.prototype.__encryptLogin=function(e,t){return{encrypted:o.asymmetricEncrypt(t,this.options.privateKey,JSON.stringify(e)),publicKey:e.publicKey,loginType:null!=e.loginType?e.loginType:"password"}},e.prototype.__decryptLogin=function(e){try{return JSON.parse(o.asymmetricDecrypt(this.serverInfo.publicKey,this.options.privateKey,e.encrypted))}catch(t){throw t}},e.prototype.__encryptPayload=function(e){return{sessionId:e.sessionId,encrypted:o.symmetricEncryptObject(e,this.session.secret)}},e.prototype.__decryptPayload=function(e){var t=o.symmetricDecryptObject(e,this.session.secret);return t},e.prototype.__ensureCryptoLibrary=c(function(e){return o?e():void(s?this.getScript(this.options.url+"/browser_crypto.js",function(t){return t?e(t):(o=new window.Crypto,void e())}):(Crypto=require("happn-util-crypto"),o=new Crypto,e()))}),e.prototype.__attachSession=function(e){if(delete e._meta,this.session=e,s){var t=(e.cookieName||"happn_token")+"="+this.session.token+"; path=/;";e.cookieDomain&&(t+=" domain="+e.cookieDomain+";"),document.cookie=t}},e.prototype.__payloadToError=function(e){var t=new Error(e.toString());return e.message&&(t.message=e.message),t},e.prototype.__doLogin=function(e,t){var n=this,o=function(t){n.__performSystemRequest("login",e,{timeout:n.options.loginTimeout},function(e,o){return e?t(e):void("ok"==o._meta.status?(n.__attachSession(o),t()):t(n.__payloadToError(o.payload)))})};if(!n.options.loginRetry)return o(t);n.options.loginRetryInterval&&"number"==typeof n.options.loginRetryInterval||(n.options.loginRetryInterval=5e3);var r=0,i=!1;n.utils.whilst(function(){return r<n.options.loginRetry&&0==i},function(e,t){r++,o(function(e){return e?[403,401].indexOf(e.code)>-1?t(e):r==n.options.loginRetry?t(e):setTimeout(t,n.options.loginRetryInterval):(i=!0,t())})},t)},e.prototype.__signNonce=function(e){return o.sign(e,this.options.privateKey)},e.prototype.__prepareLogin=function(e,t){var n=this,o=function(e){n.serverInfo.encryptPayloads&&(e=n.__encryptLogin(e,n.serverInfo.publicKey)),t(null,e)};"digest"==e.loginType?n.__performSystemRequest("request-nonce",{publicKey:e.publicKey},null,function(r,i){return r?t(r):(e.digest=n.__signNonce(i.nonce),void o(e))}):o(e)},e.prototype.login=c(function(e){var t=this,n={username:this.options.username,info:this.options.info,protocol:a};n.info._browser=s,n.info._local=t.socket._local?!0:!1,this.options.password&&(n.password=this.options.password),this.options.publicKey&&(n.publicKey=this.options.publicKey),this.options.token&&(n.token=this.options.token),"happn_{{protocol}}"===a&&(a="happn"),t.__performSystemRequest("configure-session",{protocol:a},null,function(r){return r?e(r):void t.__performSystemRequest("describe",null,null,function(r,i){if(r)return e(r);if(t.serverInfo=i,t.serverInfo.secure){if(!n.token&&!n.username)return e(new Error("happn server is secure, please specify a username or token"));if(!n.password&&!n.token){if(!n.publicKey)return e(new Error("happn server is secure, please specify a password"));n.loginType="digest"}t.serverInfo.encryptPayloads||"digest"===n.loginType?t.__ensureCryptoLibrary(function(r){if(r)return e(r);if(!t.options.privateKey||!t.options.publicKey){if("digest"===n.loginType)return e(new Error("login type is digest, but no privateKey and publicKey specified"));var i=o.createKeyPair();t.options.publicKey=i.publicKey,t.options.privateKey=i.privateKey}n.publicKey=t.options.publicKey,t.__prepareLogin(n,function(n,o){return n?e(n):void t.__doLogin(o,e)})}):t.__doLogin(n,e)}else t.__doLogin(n,e)})})}),e.prototype.authenticate=c(function(e){var t=this;return t.socket?void t.login(e):void t.__getConnection(function(n,o){return n?e(n):(t.socket=o,t.socket.on("data",t.handle_publication.bind(t)),t.socket.on("reconnected",t.reconnect.bind(t)),t.socket.on("end",t.handle_end.bind(t)),t.socket.on("close",t.handle_end.bind(t)),t.socket.on("reconnect timeout",t.handle_reconnect_timeout.bind(t)),t.socket.on("reconnect scheduled",t.handle_reconnect_scheduled.bind(t)),void t.login(e))})}),e.prototype.handle_end=function(){this.state=i.DISCONNECTED,this.session?this.emit("connection-ended",this.session.id):this.emit("connection-ended")},e.prototype.handle_reconnect_timeout=function(e,t){this.state=i.DISCONNECTED,this.emit("reconnect-timeout",{err:e,opts:t})},e.prototype.handle_reconnect_scheduled=function(e){var t=this;t.state=i.RECONNECTING,t.__reconnectSuccessful=!1,t.emit("reconnect-scheduled",e),t.options.pool&&(t.socket=null,t.reconnect(function(e){e&&t.handle_error(new Error("pooled subscription reconnection failed",e))}))},e.prototype.getEventId=function(){return this.currentEventId+=1},e.prototype.__requestCallback=function(e,t,n,o,r,i){var s={eventId:e.eventId,client:this,handler:t};s.handleResponse=function(e,t){return clearTimeout(this.timedout),delete this.client.requestEvents[this.eventId],this.handler(e,t)}.bind(s),s.timedout=setTimeout(function(){delete this.client.requestEvents[this.eventId];var e="api request timed out";return r&&(e+=" path: "+r),i&&(e+=" action: "+i),this.handler(new Error(e))}.bind(s),n.timeout),this.requestEvents[o]=s},e.prototype.__performDataRequest=function(e,t,n,o,r){if(this.state!=i.ACTIVE)return r(this.state===i.CONNECT_ERROR?new Error("client in an error state."):this.state===i.ERROR?new Error("client in an error state."):this.state===i.UNINITIALIZED?new Error("client not initialized yet."):this.state===i.DISCONNECTED?new Error("client is disconnected"):new Error("client not active"));var s=this.getEventId(),a={action:t,eventId:s,path:e,data:n,sessionId:this.session.id};o?a.options=o:o={},["set","remove"].indexOf(t)>=0&&(o.consistency==this.constants.CONSISTENCY.DEFERRED||o.consistency==this.constants.CONSISTENCY.ACKNOWLEDGED)&&this.__attachPublishedAck(o,a),o.timeout||(o.timeout=this.options.callTimeout),this.serverInfo.encryptPayloads&&(a=this.__encryptPayload(a)),r&&this.__requestCallback(a,r,o,s,e,t),this.socket.write(a)},e.prototype.__performSystemRequest=function(e,t,n,o){var r=this.getEventId(),i={action:e,eventId:r};void 0!=t&&(i.data=t),this.session&&(i.sessionId=this.session.id),n?i.options=n:n={},n.timeout||(n.timeout=this.options.callTimeout),o&&this.__requestCallback(i,o,n,r),this.socket.write(i)},e.prototype.getChannel=function(e,t){return this.utils.checkPath(e),"/"+t.toUpperCase()+"@"+e},e.prototype.get=c(function(e,t,n){"function"==typeof t&&(n=t,t={}),this.__performDataRequest(e,"get",null,t,n)}),e.prototype.getPaths=c(function(e,t){this.get(e,{options:{path_only:!0}},t)}),e.prototype.set=c(function(e,t,n,o){"function"==typeof n&&(o=n,n={}),null===t&&(n.nullValue=!0),this.__performDataRequest(e,"set",t,n,o)}),e.prototype.setSibling=c(function(e,t,n){this.set(e,t,{set_type:"sibling"},n)}),e.prototype.remove=c(function(e,t,n){return"function"==typeof t&&(n=t,t={}),this.__performDataRequest(e,"remove",null,t,n)}),e.prototype.__reattachListeners=function(e){var t=this;t.utils.async(Object.keys(t.events),function(e,n,o){var r=t.events[e];t.utils.async(r,function(n,o,r){var i={refCount:1,listenerId:n.id};n.meta&&(i.meta=n.meta),t._remoteOn(e,i,function(t,o){return t?r(new Error("failed re-establishing listener to path: "+e,t)):(n.referenceId=o.id,void r())})},o)},e)},e.prototype.reconnect=function(e){var t=this;t.state=i.ACTIVE,t.emit("reconnect",e),t.authenticate(function(n){return t.__reconnectSuccessful?void 0:n?n.message&&0==n.message.indexOf("api request timed out")?t.reconnect():t.handle_error(n,3):void t.__reattachListeners(function(n){return n?t.handle_error(n,3):(t.__reconnectSuccessful=!0,void t.emit("reconnect-successful",e))})})},e.prototype.handle_error=function(e,t){t||(t=1),this.errors.length>=100?this.errors.splice(e,this.errors.length-1,1):this.errors.push(e),this.log.error("unhandled error",e),this.state=i.ERROR},e.prototype.__attachPublishedAck=function(e,t){var n=this;if("function"!=typeof e.onPublished)throw new Error("onPublish handler in options is missing");var o=e.onPublishedTimeout||6e4,r={id:t.sessionId+"-"+t.eventId,onPublished:e.onPublished,handle:function(e,t){clearTimeout(this.timeout),delete n.__ackHandlers[this.id],this.onPublished(e,t)},timedOut:function(){this.handle(new Error("publish timed out"))}};r.timeout=setTimeout(r.timedOut.bind(r),o),n.__ackHandlers[r.id]=r},e.prototype.handle_ack=function(e){var t=this;if(t.__ackHandlers[e.id]){if("error"==e.status)return t.__ackHandlers[e.id].handle(new Error(e.error),e.result);t.__ackHandlers[e.id].handle(null,e.result)}},e.prototype.handle_publication=function(e){if(e.encrypted&&(e=e._meta&&"login"==e._meta.type?this.__decryptLogin(e):this.__decryptPayload(e.encrypted)),e._meta&&"system"==e._meta.type)return this.__handleSystemMessage(e);if(e._meta&&"data"==e._meta.type)return this.handle_data(e._meta.channel,e);if(e._meta&&"ack"==e._meta.type)return this.handle_ack(e);if(Array.isArray(e))this.handle_response_array(null,e,e.pop());else if("error"==e._meta.status){var t=e._meta.error,n=new Error;n.name=t.name||t.message||t,Object.keys(t).forEach(function(e){n[e]||(n[e]=t[e])}),this.handle_response(n,e)}else{var o;e.data?(o=e.data,o._meta=e._meta):o=e,null===e.data&&(o._meta.nullData=!0),this.handle_response(null,o)}},e.prototype.handle_response_array=function(e,t,n){var o=this.requestEvents[n.eventId];o&&o.handleResponse(e,t)},e.prototype.handle_response=function(e,t){var n=this.requestEvents[t._meta.eventId];if(n){if(t._meta.nullData)return n.handleResponse(e,null);n.handleResponse(e,t)}},e.prototype.__acknowledge=function(e,t){return e._meta.consistency===this.constants.CONSISTENCY.ACKNOWLEDGED?(e._meta.acknowledged=!0,this.__performDataRequest(e.path,"ack",e._meta.publicationId,null,function(n){n&&(e._meta.acknowledged=!1,e._meta.acknowledgedError=n),t&&t(e)})):void(t&&t(e))},e.prototype.delegate_handover=function(e,t){var n=this;return t.count>0&&t.runcount>=t.count?n.__acknowledge(e):(t.runcount++,void n.__acknowledge(e,function(e){return t.count>0&&t.count==t.runcount?n._offListener(t.id,function(o){return o?n.handle_error(o):void t.handler.call(n,e.data,e._meta)}):void t.handler.call(n,e.data,e._meta)}))},e.prototype.handle_data=function(e,t){var n=this;if(n.events[e]){if(1==n.events[e].length)return n.delegate_handover(t,n.events[e][0]);if(n.events[e].length>1){var o=JSON.stringify(t);n.events[e].map(function(e){n.delegate_handover(JSON.parse(o),e)})}}},e.prototype.__handleSystemMessage=function(e){"server-side-disconnect"==e.eventKey&&(this.state=i.DISCONNECTED),this.__systemMessageHandlers.every(function(t){return t.apply(t,[e.eventKey,e.data])})},e.prototype.offSystemMessage=function(e){this.__systemMessageHandlers.splice(e,1)},e.prototype.onSystemMessage=function(e){return this.__systemMessageHandlers.push(e),this.__systemMessageHandlers.length-1},e.prototype._remoteOn=function(e,t,n){this.__performDataRequest(e,"on",null,t,n)},e.prototype.on=c(function(e,t,n,o){var r=this;if("function"==typeof t&&(o=n,n=t,t={}),t||(t={}),t.event_type&&"*"!=t.event_type||(t.event_type="all"),t.count||(t.count=0),t.listenerId=r.currentListenerId++,!o){if("function"!=typeof t.onPublished)throw new Error("you cannot subscribe without passing in a subscription callback");if("function"!=typeof n)throw new Error("callback cannot be null when using the onPublished event handler");o=n,n=t.onPublished}e=r.getChannel(e,t.event_type),r.events[e]||(r.events[e]=[]),r._remoteOn(e,t,function(i,s){if(i)return o(i);if("error"==s.status)return o(s.payload);var a={handler:n,count:t.count,id:t.listenerId,referenceId:s.id,runcount:0,meta:t.meta};return r.events[e].push(a),t.initialEmit&&s.length>0&&s.forEach(function(e,t){t<s.length&&a.handler(e)}),t.onPublished?o(null,t.listenerId):void o(null,t.listenerId,s)})}),e.prototype.onAll=c(function(e,t){this.on("*",null,e,t)}),e.prototype._remoteOff=function(e,t,n){"function"==typeof t&&(n=t,t=0),this.__performDataRequest(e,"off",null,{referenceId:t},function(e,t){return e?n(e):"error"==t.status?n(t.payload):void n()})},e.prototype._offListener=function(e,t){function n(e,n,r){o._remoteOff(e,r.referenceId,function(e){return e?t(e):(n.splice(n.indexOf(r),1),void t())})}var o=this;if(!o.events||0==o.events.length)return t();var r=!1;for(var i in o.events){var s=o.events[i];if(!s)return t();s.every(function(t){return t.id==e?(r=!0,n(i,s,t),!1):!0})}return r?void 0:t()},e.prototype._offPath=function(e,t){var n=this,o=!1,r=[];for(var i in n.events){var s=i.split("@"),a=s.slice(1,s.length).join("@");n.utils.wildcardMatch(e,a)&&(o=!0,r.push(i))}return o?void n.utils.async(r,function(e,t,o){n._remoteOff(e,function(t){return t?o(t):(delete n.events[e],void o())})},t):t()},e.prototype.offAll=c(function(e){var t=this;return t._remoteOff("*",function(n){return n?e(n):(t.events={},void e())})}),e.prototype.off=c(function(e,t){return null==e?t(new Error("handle cannot be null")):"number"!=typeof e?t(new Error("handle must be a number")):void this._offListener(e,t)}),e.prototype.offPath=c(function(e,t){return"function"==typeof e&&(t=e,e="*"),this._offPath(e,t)}),e.prototype.__connectionCleanup=function(){try{this.socket&&this.socket.end()}catch(e){}},e.prototype.revokeSession=c(function(e){this.__performSystemRequest("revoke-session",null,null,e)}),e.prototype.disconnect=c(function(e,t){"function"==typeof e&&(t=e,e=null),e||(e={}),e.timeout||(e.timeout=6e4),t||(t=function(){});var n=this;if(n.disconnectTimeout&&clearTimeout(n.disconnectTimeout),n.state==i.DISCONNECTED||n.state==i.CONNECTING||n.state==i.CONNECT_ERROR)return n.__connectionCleanup(),t();if(n.disconnectTimeout=setTimeout(function(){n.log.warn("disconnect timeout hit"),n.state!==i.DISCONNECTING&&null!=n.socket&&n.__connectionCleanup(),t&&t(new Error("disconnect timed out"))},e.timeout),n.__systemMessageHandlers=[],n.eventHandlers={},null!=n.socket){if(n.socket.removeAllListeners("end"),n.socket.once("end",function(){return clearTimeout(n.disconnectTimeout),n.state=i.DISCONNECTED,t()}),n.state!==i.ACTIVE&&n.state!==i.CONNECTED)return n.state=i.DISCONNECTING,void n.__connectionCleanup();n.__performSystemRequest("disconnect",null,e,function(e){e&&n.log.warn("disconnect call failed"),n.state=i.DISCONNECTING,n.__connectionCleanup()})}else n.state=i.DISCONNECTED})}();